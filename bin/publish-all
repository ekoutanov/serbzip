#!/bin/bash
set -e

type cargo-get >/dev/null 2>&1 || { echo >&2 "cargo-get is not installed; aborting."; exit 1; }

base_dir="$(dirname "$0")"
cd ${base_dir}/..
new_version=$(cd serbzip; cargo get version)

function await() {
  package=$1
  echo -n "Awaiting indexing of package ${package}"
  while [ true ]; do
    has_no_version=$(curl -isS https://crates.io/api/v1/crates/${package}/${new_version} | grep "does not have a version" | wc -l)
    if [ "${has_no_version}" -eq "1" ]; then
      echo -n "."
      sleep 2
    else
      echo
      break
    fi

  done
}

echo "Publishing all packages for serbzip ${new_version}"

cargo publish -p serbzip-core
await serbzip-core
cargo publish -p serbzip