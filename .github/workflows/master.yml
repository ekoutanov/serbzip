name: Cargo build

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions-rs/cargo@v1
        with:
          command: test
          args: -- #--include-ignored
      - run: bin/test-compression.sh
      - run: rustup component add llvm-tools-preview
      - run: export RUSTFLAGS="-Cinstrument-coverage"
      - run: cargo build
      - run: export LLVM_PROFILE_FILE="serbzip-%p-%m.profraw"
      - run: cargo test
      - run: curl -L https://github.com/mozilla/grcov/releases/latest/download/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf -
      - run: ./grcov . --binary-path ./target/debug/ -s . -t lcov --branch --ignore-not-existing --ignore "/*" -o lcov.info
      - run: bash <(curl -s https://codecov.io/bash) -f lcov.info